---
layout: post
title: "Recommending movies using Spark's Matrix Factorization Model"
date: 2016-05-29
description: "Making recommendations using movielens data"
main-class: 'spark'
published: true
postbook: 'inotebook'
color: '#7AAB13'
tags:
- spark
- "matrix factorization"
- movielens
- 'alternating least square'
- recommendation
- mllib
categories:
- spark
introduction: "Making recommendations using movielens data"
---

<div tabindex="-1" id="notebook" class="border-box-sizing">
  <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Movie-Recommendations-using-Matrix-Factorization">Movie Recommendations using Matrix Factorization<a class="anchor-link" href="#Movie-Recommendations-using-Matrix-Factorization">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>This tutorial will give quick introduction to recommendations using matrix factorization method. We will be using movielens data for making recommendations. The dataset is available <a href="https://grouplens.org/datasets/movielens/">here</a>.</li>
<li>There is a tutorial on recommendations systems and collaborative filtering <a href="http://www.awesomestats.in/python-recommending-movies/">here</a>, which introduces the dataset and how collborative filtering techniques like user similarity and item similarity can be used to make recommendations.</li>
</ul>
<h2 id="Matrix-Factorization">Matrix Factorization<a class="anchor-link" href="#Matrix-Factorization">&#182;</a></h2><ul>
<li>Matrix Factorization is also know as latent factors. This technique will decompose the original matrix (which represents the ratings given by users for different movies) into two matrixes as follows.</li>
</ul>
<p><img src="/assets/img/python/recomend-3.png" width="400"></p>
<ul>
<li>Where the left matrix represents the users as rows and the features as columns. And the cell values represent the user's like-ness for these features. There are no explicit intrepretation of these feautures and hence these are called latent factors. And the right matrix represents the movies and their weightage on these features.</li>
<li>So, when there are features available in a movie that a particular user like, it is expected that the user would like that movie.</li>
</ul>
<h3 id="Mathematically">Mathematically<a class="anchor-link" href="#Mathematically">&#182;</a></h3><p>if <strong>P</strong> is user matrix with user as rows and features as columns
if <strong>Q</strong> is item matrix with item as rows and features as columns</p>
<p>Then the user-item rating matrix can be written as</p>
<p>${R} \approx \mathbf{P} \times \mathbf{Q}^T = \hat{\mathbf{R}}$</p>
<p>where every element of the matrix can be computed as,</p>
<p>${r}_{ij} = p_i^T q_j = \sum_{k=1}^k{p_{ik}q_{kj}}$</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Using-Spark-MLIB-for-making-recommendations">Using Spark MLIB for making recommendations<a class="anchor-link" href="#Using-Spark-MLIB-for-making-recommendations">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Verify-Spark-Context">Verify Spark Context<a class="anchor-link" href="#Verify-Spark-Context">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[19]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sc</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[19]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&lt;pyspark.context.SparkContext at 0x102dbf908&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[20]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">master</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[20]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&#39;local[*]&#39;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[21]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">version</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[21]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>&#39;2.0.1&#39;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Read-ratings-data-into-dataframe">Read ratings data into dataframe<a class="anchor-link" href="#Read-ratings-data-into-dataframe">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Define-dataframe-schema">Define dataframe schema<a class="anchor-link" href="#Define-dataframe-schema">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[22]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">ratings_df_schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">(</span>
<span class="p">[</span><span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
 <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;movieId&#39;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
 <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">())]</span>
<span class="p">)</span>
<span class="n">movies_df_schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">(</span>
<span class="p">[</span><span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
 <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())]</span>
<span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-the-dataset-using-the-schema-above">Load the dataset using the schema above<a class="anchor-link" href="#Load-the-dataset-using-the-schema-above">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[23]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">raw_ratings_df</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;com.databricks.spark.csv&#39;</span><span class="p">)</span>        \
              <span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">inferSchema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>              \
              <span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">ratings_df_schema</span><span class="p">)</span>                                 \
              <span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="s2">&quot;file:///Users/manaranjan/Documents/Work/Spark/MyTutorials/movies/data/ratings.dat&quot;</span> <span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There is another tutorial <a href="http://www.awesomestats.in/spark-dataframe-movies/">here</a>, which does intital exploratory analysis of the movielens dataset.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Drop-the-timestamp-column">Drop the timestamp column<a class="anchor-link" href="#Drop-the-timestamp-column">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ratings_df</span> <span class="o">=</span> <span class="n">raw_ratings_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Timestamp&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ratings_df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>+------+-------+------+
|userId|movieId|rating|
+------+-------+------+
|     1|   1193|   5.0|
|     1|    661|   3.0|
|     1|    914|   3.0|
|     1|   3408|   4.0|
|     1|   2355|   5.0|
|     1|   1197|   3.0|
|     1|   1287|   5.0|
|     1|   2804|   5.0|
|     1|    594|   4.0|
|     1|    919|   4.0|
+------+-------+------+
only showing top 10 rows

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Read-movies-data-into-dataframe">Read movies data into dataframe<a class="anchor-link" href="#Read-movies-data-into-dataframe">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">raw_movies_df</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;com.databricks.spark.csv&#39;</span><span class="p">)</span>            \
              <span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inferSchema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>    \
              <span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">movies_df_schema</span><span class="p">)</span>                                     \
              <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;file:///Users/manaranjan/Documents/Work/Spark/MyTutorials/movies/data/movies.dat&quot;</span><span class="p">)</span>

<span class="n">movies_df</span> <span class="o">=</span> <span class="n">raw_movies_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Genres&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;movieId&#39;</span><span class="p">,</span> <span class="s1">&#39;ID&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Cache-both-the-dataframes">Cache both the dataframes<a class="anchor-link" href="#Cache-both-the-dataframes">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ratings_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">movies_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[9]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>DataFrame[ID: int, title: string]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movies_df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>+---+----------------------------------+
|ID |title                             |
+---+----------------------------------+
|1  |Toy Story (1995)                  |
|2  |Jumanji (1995)                    |
|3  |Grumpier Old Men (1995)           |
|4  |Waiting to Exhale (1995)          |
|5  |Father of the Bride Part II (1995)|
|6  |Heat (1995)                       |
|7  |Sabrina (1995)                    |
|8  |Tom and Huck (1995)               |
|9  |Sudden Death (1995)               |
|10 |GoldenEye (1995)                  |
+---+----------------------------------+
only showing top 10 rows

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Splitting-the-ratings-dataset">Splitting the ratings dataset<a class="anchor-link" href="#Splitting-the-ratings-dataset">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Splitting the dataset into train, validate and test with 60:20:20 proportions.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">training_df</span><span class="p">,</span> <span class="n">validation_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Let's-cache-the-data-splits">Let's cache the data splits<a class="anchor-link" href="#Let's-cache-the-data-splits">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">training_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">validation_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">test_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[12]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>DataFrame[userId: int, movieId: int, rating: double]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Building-the-model">Building the model<a class="anchor-link" href="#Building-the-model">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.recommendation</span> <span class="k">import</span> <span class="n">ALS</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Initialize-the-parameters">Initialize the parameters<a class="anchor-link" href="#Initialize-the-parameters">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">MAX_ITERATIONS</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">REG_PARAM</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">SEED_VALUE</span> <span class="o">=</span> <span class="mi">42</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Initialize-the-ALS()-method">Initialize the ALS() method<a class="anchor-link" href="#Initialize-the-ALS()-method">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">als</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[16]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Now we set the parameters for the method</span>
<span class="n">als</span><span class="o">.</span><span class="n">setMaxIter</span><span class="p">(</span><span class="n">MAX_ITERATIONS</span><span class="p">)</span>          \
 <span class="o">.</span><span class="n">setSeed</span><span class="p">(</span><span class="n">SEED_VALUE</span><span class="p">)</span>                 \
 <span class="o">.</span><span class="n">setRegParam</span><span class="p">(</span><span class="n">REG_PARAM</span><span class="p">)</span>              \
 <span class="o">.</span><span class="n">setUserCol</span><span class="p">(</span><span class="s1">&#39;userId&#39;</span><span class="p">)</span>                \
 <span class="o">.</span><span class="n">setItemCol</span><span class="p">(</span><span class="s1">&#39;movieId&#39;</span><span class="p">)</span>               \
 <span class="o">.</span><span class="n">setRatingCol</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[16]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>ALS_423d8997d18d18e757a1</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Define-an-evaluator">Define an evaluator<a class="anchor-link" href="#Define-an-evaluator">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[17]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.evaluation</span> <span class="k">import</span> <span class="n">RegressionEvaluator</span>

<span class="c1"># Create an RMSE evaluator using the label and predicted columns</span>
<span class="n">reg_eval</span> <span class="o">=</span> <span class="n">RegressionEvaluator</span><span class="p">(</span><span class="n">predictionCol</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="n">labelCol</span><span class="o">=</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="n">metricName</span><span class="o">=</span><span class="s2">&quot;rmse&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Search-for-the-best-rank">Search for the best rank<a class="anchor-link" href="#Search-for-the-best-rank">&#182;</a></h3><ul>
<li>The rank is number of latent factors to be created during matrix factorization.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[18]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ranks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>
<span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">min_error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
<span class="n">best_rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="n">ranks</span><span class="p">:</span>

  <span class="c1"># Build the model    </span>
  <span class="n">als</span><span class="o">.</span><span class="n">setRank</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">als</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">training_df</span><span class="p">)</span>

  <span class="c1"># Make predictions on validation dataset  </span>
  <span class="n">predict_df</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">validation_df</span><span class="p">)</span>

  <span class="n">predicted_ratings_df</span> <span class="o">=</span> <span class="n">predict_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">predict_df</span><span class="o">.</span><span class="n">prediction</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>

  <span class="c1"># Run the previously created RMSE evaluator, reg_eval, on the predicted_ratings_df DataFrame</span>
  <span class="n">error</span> <span class="o">=</span> <span class="n">reg_eval</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">predicted_ratings_df</span><span class="p">)</span>
  <span class="n">errors</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>
  <span class="n">models</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
  <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;For rank </span><span class="si">%s</span><span class="s1"> the RMSE is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">)</span>

  <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">min_error</span><span class="p">:</span>
      <span class="n">min_error</span> <span class="o">=</span> <span class="n">error</span>
      <span class="n">best_rank</span> <span class="o">=</span> <span class="n">count</span>
  <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">als</span><span class="o">.</span><span class="n">setRank</span><span class="p">(</span><span class="n">ranks</span><span class="p">[</span><span class="n">best_rank</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;The best model was trained with rank </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ranks</span><span class="p">[</span><span class="n">best_rank</span><span class="p">]</span> <span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>For rank 4 the RMSE is 0.8867890644965285
For rank 8 the RMSE is 0.8797676929458298
For rank 12 the RMSE is 0.8755249202840839
For rank 15 the RMSE is 0.8764000006223175
The best model was trained with rank 12
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Select-the-model-with-best-rank">Select the model with best rank<a class="anchor-link" href="#Select-the-model-with-best-rank">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[24]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">best_model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">best_rank</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Apply-the-model-on-test-dataset">Apply the model on test dataset<a class="anchor-link" href="#Apply-the-model-on-test-dataset">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[26]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_predict_df</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[27]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_predict_df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>+------+-------+------+----------+
|userId|movieId|rating|prediction|
+------+-------+------+----------+
|   673|    148|   5.0| 2.8468165|
|  1242|    148|   3.0| 1.8392601|
|  3539|    148|   3.0| 2.6630893|
|  1605|    148|   2.0| 2.1126497|
|   752|    148|   4.0|  2.807478|
|   424|    148|   4.0|  2.645493|
|  3841|    463|   3.0| 2.7476552|
|  3683|    463|   1.0| 1.4153442|
|   721|    463|   4.0| 3.2623837|
|  5511|    463|   2.0| 3.3263845|
+------+-------+------+----------+
only showing top 10 rows

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[28]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_predict_df</span> <span class="o">=</span> <span class="n">test_predict_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">test_predict_df</span><span class="o">.</span><span class="n">prediction</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Compute-the-test-accuracy">Compute the test accuracy<a class="anchor-link" href="#Compute-the-test-accuracy">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[41]:</div>
<div class="inner_cell">
  <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_RMSE</span> <span class="o">=</span> <span class="n">reg_eval</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_predict_df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The model had a RMSE on the test set of </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_RMSE</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>The model had a RMSE on the test set of 0.8749194031094534
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The model has an RMSE of 0.875. That means when if it predicts a rating for a movie for an user it will have an error of + or - of 0.87.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusion:">Conclusion:<a class="anchor-link" href="#Conclusion:">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once the accuracy is acceptable, we can take all the data and build the model and make predictions. To make prediction for a specific user, we can filter out the movies that have not been rated by him or her earlier. And then look at which all movies have been predicted by the model to have a predicted rating beyond a certain cutoff value or sort all the movies by their predicted rating and make top 5 or 10 recommendations.</p>

</div>
</div>
</div>
  </div>
</div>
